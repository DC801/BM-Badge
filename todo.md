# todo:

## Game Engine:
- [x] Add tile flipping to render function
- [x] Entities
	- [x] Determine which entity should be player character on map load
- [x] Handle player input
- [x] Add entity render ordering by coordinate of bottom edge
- [x] Add support for entity animation timing
	- [x] Make an array of uint16s that just hold the current frame for entities; it doesn't need to be hackable, just stateful
	- [x] Reset
- [x] Port over the sdl_toy_0 button & LED state emulation
	- [x] Start rendering the background graphic
	- [x] Collect the Button coordinates
	- [x] Render the Buttons
	- [x] Collect the LED coordinates
	- [x] Render the LEDs
	- [x] Handle all inputs for the buttons
	- [x] Toggle the button renderable states when buttons are down
	- [x] Toggle the LED/Boolean values when the buttons are pressed
- [x] Generate a bunch of different WAV files of different sample rates for Dovid
- [x] Port over the Hex Editor
	- [x] Build Monaco 9 as an AdaGFXFont because we need a good monospace font
	- [x] Start rendering the text for the byte grid
	- [x] Render byte selection cursor behind the text
	- [x] Arrows navigate cursor on byte grid when hex editor is open
	- [x] Pass states of currently selected byte to the LEDs
	- [x] Build the entity RAM <-> uint8_t array mapper/typecasting?
	- [x] Build hex ops handler functions
	- [x] Trigger swap of hex ops enum
	- [x] Build hex bit handler functions
	- [x] Trigger hex bit handler to change value of bits on selected byte
	- [x] Build MEM button handler functions
	- [x] Add ability to offset visible page of RAM by pages
	- [x] Render something on screen to see which RAM PAGE you're on
	- [x] Add PAGE handler; Hold page + arrows to jump pages of bytes?
	- [x] Start adding error handling for when indexing outside of supported types ROM data
- [x] Move functions for reading from the ROM into `mage_rom.cpp`
- [x] Create some `get_*_by_index` functions for validating hackable datas
	- [x] getValidEntityId
	- [x] getValidMapId
	- [x] getValidPrimaryIdType
	- [x] getValidTilesetId
	- [x] getValidTileId
	- [x] getValidAnimationId
	- [x] getValidAnimationFrame
	- [x] getValidEntityTypeId
	- [x] getValidEntityTypeAnimationId
	- [x] getValidEntityTypeDirection
- [x] In the ROM header, add a timestamp so we know if the game.dat should be replaced with SD card versions.
- [x] Make a list of some C functions we want scripts to be able to call
- [x] Decide on a common script function signature
- [x] Define an encoding format for scripts
- [x] Adjust entity animation system to allow for multiple actions that can be called from scripts
- [x] Make it so that maps denote a player entity by ID in the game.dat file, and only has ONE or ZERO players per map.
- [x] Change map reset keybind to be XOR+MEM3 and make it work even in dialogs and the hex editor
- [ ] Script system
	- [x] Binary Encoder parts
	- [x] Scripts
		- [x] What is a script?
			- [x] It's a length + sequence of Actions
			- [x] Scripts shouldn't be able to be called when the player has opened the hex editor, but scripts should be able to open the hex editor when called from elsewhere.
			- [x] We'll need entity-based state variables to track pathing and other transient values between ticks.
		- [x] Map
			- [x] onMapLoad(uint16_t scriptId); //called once when the map loads
			- [x] onMapTick(uint16_t scriptId); //called every tick, used for doors, other static events when moving around map.
		- [x] Entity
			- [x] onEntityTick(uint16_t scriptId, uint8_t entityId); //called every tick, entityId is the entity calling that script.
			- [x] onEntityInteract(uint16_t scriptId); //called when the player interacts with the entity
	- [ ] Actions (see mage_defines.h for structs detailing arguments for each action type below:)
		- [x] NULL_ACTION
		- [x] CHECK_ENTITY_NAME
		- [x] CHECK_ENTITY_X
		- [x] CHECK_ENTITY_Y
		- [x] CHECK_ENTITY_INTERACT_SCRIPT
		- [x] CHECK_ENTITY_TICK_SCRIPT
		- [x] CHECK_ENTITY_TYPE
		- [x] CHECK_ENTITY_PRIMARY_ID
		- [x] CHECK_ENTITY_SECONDARY_ID
		- [x] CHECK_ENTITY_PRIMARY_ID_TYPE
		- [x] CHECK_ENTITY_CURRENT_ANIMATION
		- [x] CHECK_ENTITY_CURRENT_FRAME
		- [x] CHECK_ENTITY_DIRECTION
		- [x] CHECK_ENTITY_GLITCHED
		- [ ] CHECK_ENTITY_HACKABLE_STATE_A
		- [ ] CHECK_ENTITY_HACKABLE_STATE_B
		- [ ] CHECK_ENTITY_HACKABLE_STATE_C
		- [ ] CHECK_ENTITY_HACKABLE_STATE_D
		- [ ] CHECK_ENTITY_HACKABLE_STATE_A_U2
		- [ ] CHECK_ENTITY_HACKABLE_STATE_C_U2
		- [ ] CHECK_ENTITY_HACKABLE_STATE_A_U4
		- [ ] CHECK_ENTITY_PATH (specific hackable state check by name)
		- [x] CHECK_SAVE_FLAG
		- [x] CHECK_IF_ENTITY_IS_IN_GEOMETRY
		- [x] CHECK_FOR_BUTTON_PRESS
		- [x] CHECK_FOR_BUTTON_STATE
		- [x] CHECK_WARP_STATE
		- [x] RUN_SCRIPT
		- [x] BLOCKING_DELAY
		- [x] NON_BLOCKING_DELAY
		- [ ] PAUSE_GAME
		- [ ] PAUSE_ENTITY_SCRIPT
		- [x] SET_ENTITY_NAME
		- [x] SET_ENTITY_X
		- [x] SET_ENTITY_Y
		- [x] SET_ENTITY_INTERACT_SCRIPT
		- [x] SET_ENTITY_TICK_SCRIPT
		- [x] SET_ENTITY_TYPE
		- [x] SET_ENTITY_PRIMARY_ID
		- [x] SET_ENTITY_SECONDARY_ID
		- [x] SET_ENTITY_PRIMARY_ID_TYPE
		- [x] SET_ENTITY_CURRENT_ANIMATION - Encoder needs to lookup animation NAME, not index
		- [x] SET_ENTITY_CURRENT_FRAME
		- [x] SET_ENTITY_DIRECTION
		- [x] SET_ENTITY_DIRECTION_RELATIVE
		- [x] SET_ENTITY_DIRECTION_TARGET_ENTITY
		- [x] SET_ENTITY_DIRECTION_TARGET_GEOMETRY
		- [x] SET_ENTITY_GLITCHED
		- [ ] SET_ENTITY_HACKABLE_STATE_A
		- [ ] SET_ENTITY_HACKABLE_STATE_B
		- [ ] SET_ENTITY_HACKABLE_STATE_C
		- [ ] SET_ENTITY_HACKABLE_STATE_D
		- [ ] SET_ENTITY_HACKABLE_STATE_A_U2
		- [ ] SET_ENTITY_HACKABLE_STATE_C_U2
		- [ ] SET_ENTITY_HACKABLE_STATE_A_U4
		- [ ] SET_ENTITY_PATH (specific hackable state check by name)
		- [x] SET_SAVE_FLAG
		- [x] SET_PLAYER_CONTROL
		- [x] SET_MAP_TICK_SCRIPT
		- [x] SET_HEX_CURSOR_LOCATION
		- [ ] SET_HEX_BITS
		- [x] SET_WARP_STATE
		- [ ] UNLOCK_HAX_CELL
		- [ ] LOCK_HAX_CELL
		- [x] SET_HEX_EDITOR_STATE
		- [x] SET_HEX_EDITOR_DIALOG_MODE
		- [x] SET_HEX_EDITOR_CONTROL
		- [x] LOAD_MAP
		- [x] SHOW_DIALOG
		- [x] PLAY_ENTITY_ANIMATION
		- [x] TELEPORT_ENTITY_TO_GEOMETRY
		- [x] WALK_ENTITY_TO_GEOMETRY
		- [x] WALK_ENTITY_ALONG_GEOMETRY
		- [x] LOOP_ENTITY_ALONG_GEOMETRY
		- [x] SET_CAMERA_TO_FOLLOW_ENTITY
		- [x] TELEPORT_CAMERA_TO_GEOMETRY
		- [x] PAN_CAMERA_TO_ENTITY
		- [x] PAN_CAMERA_TO_GEOMETRY
		- [ ] PAN_CAMERA_ALONG_GEOMETRY
		- [ ] LOOP_CAMERA_ALONG_GEOMETRY
		- [x] SET_SCREEN_SHAKE
		- [x] SCREEN_FADE_OUT
		- [x] SCREEN_FADE_IN
		- [x] MUTATE_VARIABLE
		- [x] MUTATE_VARIABLES
		- [X] COPY_VARIABLE
		- [x] CHECK_VARIABLE
		- [x] CHECK_VARIABLES
		- [ ] PLAY_SOUND_CONTINUOUS
		- [ ] PLAY_SOUND_INTERRUPT
- [x] Geometry
	- [x] polygon(uint8_t count, x points[count])
	- [x] polyline(uint8_t count, x points[count])
	- [x] point(uint16_t x, uint16_t y)
	- [x] Geometry::inside_poly(point) collision detection function
	- [x] draw() renders geometry to screen
- [x] Collision System
	- [x] For Tiles
	- [!] For Entities
- [x] Dialog Data Type Implementation:
	- [x] Display Name - either stringId, or entityId
	- [x] The actual text to display, probably with line breaks hard coded in to keep things simple.
	- [x] byte to encode position (i.e. is the text on the top or bottom of the screen, is the portrait on the left or right side of the screen, should we display a portrait at all?, etc.).
		- [x] flags for position encoding byte:
			- [x] Top or Bottom
			- [x] Portrait on or off
			- [x] portrait left or right
	- [x] Portraits
		- [x] Encoder
			- [x] Needs new top-level protrait type
			- [x] Needs to store portrait on entityType
			- [x] Dialog
				- [x] Needs to store portrait not associated with entityType on dialog
				- [x] Manually specifyable even if not associated with any entity
				- [x] Needs to store flip_x
		- [x] Engine
			- [x] Should match current entityType of speaking entities
			- [x] Support Entity Hacked state
			- [x] look at dialog alignment, and if it's "RIGHT", toggle flip_x into the flags byte
	- [x] tilesetId and tileId for the portrait picture.
	- [x] Support for string templates that make use of hacked entity names
	- [x] Support for string templates that make use of numeric variables
	- [x] Please stop player walking when a dialog shows
	- [ ] display font
	- [ ] voice sound Id
	- [x] Dialog Responses:
		- [x] response TypeId:
			- [x] NO_RESPONSE = 0
			- [x] SELECT_FROM_SHORT_LIST = 1
			- [ ] SELECT_FROM_LONG_LIST = 2
			- [ ] ENTER_NUMBER = 2
			- [ ] ENTER_ALPHANUMERIC = 3
			- [ ] etc...
		- [ ] Player responses to dialog may be desired:
			- [ ] Assuming pop-up happens while dialog is still active:
				- [x] select from a list of options
				- [ ] enter a numerical value
				- [ ] enter an alphanumeric value (put on-screen keyboard over dialog? Cycle through all letter options like arcade name entry?)
			- [ ] new script and/or dialog to call depending on player response
				- [x] from a list of options
				- [ ] from a numerical value
				- [ ] from an alphanumeric value
		- [x] Show bouncing arrow at bottom of dialog to indicate that the player should press button to continue
- [x] Strings
	- [x] uint16_t Length
	- [x] char array with null termination Length bytes long
- [x] Save system with flags
	- [x] Player Name (12 bytes, like all other entities)
	- [x] On map init, replace player name into PlayerEntity
	- [x] Use bit flags in a specific region of the ROM chip to encode SAVE
- [ ] Allow upload of game.dat to ROM chip using nrfjprog
	- [ ] Convert game.daty into a game.hex file that writes data to address 0x12000000 and up on the ROM chip.
	- [ ] Use qcustominit.ini file added with this commit and the following command to upload:
		- `nrfjprog -f nrf52 --qspiini qcustominit.ini --program <filename>`
		- More info on nrfjprog: https://infocenter.nordicsemi.com/index.jsp?topic=%2Fug_nrf_cltools%2FUG%2Fcltools%2Fnrf_nrfjprogexe_reference.html
- [x] Fix name not sticking to player when changing rooms
- [x] Look into why EtherNettles puzzle is not triggering
	- [x] it's probably a modulo issue on tileId and tilesetId
- [ ] Make a new dialog tileset that is mostly transparent for the main menu
- [ ] Make some background artwork for the main menu
- [ ] Create action for setBackground
- [x] Fix portrait from last conversation being used on dialogScreens that have none
- [x] Remove AnimationFrames to free enough ram to run on Hardware again
- [x] Fix Color palette corruption bug
	- [x] Add corruption detection and logging
	- [x] Now just reproduce it again - what could possibly have been causing this?
		- [x] Turns out it was something indexing into `entities[255]` and mutating that entity - but entities were only allocated to 64. Entities were allocated just before the ColorPalettes.

## Playtesting night notes:
- [x] Text changes: "No! Not Tuesday, T.U.E.S.D.A.Y.!"
- [x] People hit escape to close the hex editor, and it closes the program. Oops. Default it to Alt+F4.
- [ ] An idea: I didn't see anyone saving after completing puzzles. Perhaps after each puzzle is solved, show the save dialog, so nobody loses any progress. Perhaps show this after the TUESDAY cutscene as well.
- [x] We really need to rearrange the Elder's speeches "I'm X, and I do Y" so that it is outside of the lodge. Nobody talked with them out side of the lodge without direction.
- [x] People talk to a lot of objects in the greenhouse, but don't get interactions. Add more interactions there.
- [x] People talked to the quest board, and it said nothing. Oops. Add some dialog.
- [x] There is still a debug exa in the beatrice puzzle room. Oops.
- [ ] After switching delmar from to sheep to man, you can't talk with him. Player expected to talk with him.
- [x] Fix a bug where modulo on the animation always picks (whatever, mage walking north, blitzball) when the currentAnimation is cycled - it glitches across palettes.
	- [x] This is not actually a bug, because the byte changing was primaryIdType. This is expected behavior.
- [ ] When you load from the main menu on desktop before you've created a save, it crashes.
- [x] NewGnu tried to set the corrupted byte on the Big Bad Name Book to uncorrupt the name. He was really fixated on learning about that.
	- [x] We should make it do a rot 13 of RED HERRING
- [x] Add Desvio to special thanks
- [x] Add AdwareHunter to special thanks
- [x] Add a book that mentions that you can press XOR and MEM3 to reset the map.
- [ ] Rax asks: Is there a place to snag a copy of the books outside of the game, other than to go parse the source code?
	- [ ] Me: Oh man. Not a bad idea! Perhaps we could release a little "Game Manual" with those! Perhaps a print out that's empty, and they player can fill in the values.
- [x] NewGnu found that if you set the onTick index to the save action, you can write every tick. FRY ROM STORAGE REAL QUICK
	- [x] Solution? Show a "Save completed" dialog after save completes, because then it can only burn through as fast as they can confirm the "Save completed" dialog.
- [ ] Desvio says that Bert should say something different if his name is changed to "Bart" or "Bort" - reference to Simpsons "Who would name a kid Bort" sketch
- [x] If player moves the flowers, Trekkie should yell at the player for uprooting the flowers, and then reset the position of all flowers.
- [x] Talking with the modem should cause the mage to say "Yup, looks like it's not connecting." or "Yay, it's connecting now!"
- [x] When loading a new map, put the hex cursor back at the player
- [x] There is a table tile that is on layer 3 in the inner sanctum, but the rest of them are below?
- [!] Possibly redesign the layout of the sheep quest so that the pen is not obscured by the old lady's house.
- [x] NewGnu tried to glitch the pipscat so it was in the where the cat construction crew was. Very reasonable. Should this be an alternate solution?
	- [x] I think that this should be countered with "When the cat is glitched off their stump, he should automatically walk back to the point where he started."
- [x] During CorfidBizna's playthrough, she triggered a "fade to black" script, and reloading the map didn't make things playable again.
	- [x] To fix, LoadMap should set fadeFraction to 0
- [x] Fix the ???Mystery Sink??? in the player's house?!?
- [x] Each of the members of the cat construction crew should say something different to the player when they are the PipsCat
- [ ] The path leading north of the Library should take the player to an "UNDER CONSTRUCTION" zone, saying something about how it's not ready yet.
- [ ] The wrap-around at the bottom of the map should fade out and then in again
- [x] Re-do the handling of the right side buttons when in the HexEditor
	- [x] Create Clipboard system
		- [x] Create a buffer that is sizeof(MageEntity)
		- [x] A value to indicate the length of what's on the clipboard
		- [x] Display current clipboard value in header or footer, truncated to 4 bytes and '...'
		- [x] Copy method
		- [x] Paste method
			- [x] When your paste changes the entityType AND position, it doesn't move to the pasted location for the first tick because the "Did the tile size change this tick" entity jump protection kicks in
		- [x] Store the clipboard value + length into save file as well
	- [x] △ should increment the current byte's value by 1
	- [x] ◯ should copy the current byte's value into the copy buffer
		- [x] while holding ◯, moving the left/right arrows will select additional cells
	- [x] ✕ should decrement the current byte's value by 1
	- [x] ◻ should paste the copy buffer into the current byte's value
	- [x] The value +/- operations should be slowed down
	- [x] The "triangle to open on an entity + cooldown before normal hex operation" should actually restore normal hex control via "on release handler"
- [x] Add an action to enable/disable copy & paste. It's too powerful to start the game with; Perhaps it is granted by an artifact from a dungeon in 2021?
- [ ] Re-do the handling of the MEM buttons in the HexEditor
	- [ ] Make the addresses stored relative to the currently selected entity
	- [ ] How to set relative MEM addresses?
		- [ ] Hold PAGE and press MEM* to set
		- [ ] Long-Hold MEM* to set?
	- [ ] Press MEM* to move cursor there, both in and out of the editor
	- [ ] Store your 4 MEM addresses into the save file at uint8_t, because MEMs are now relative
- [x] Prepare scenario data for bootloader's USB-C/magic drive update flavor
	- [x] `game.dat` gets a new header:
		- [x] `MAGEGAME`
		- [x] uint32_t CRC32 of the `game.dat` before the CRC32 is added
		- [x] uint32_t length of `game.dat`
	- [x] `save_[0,1,2].dat` gets a new header:
		- [x] `MAGESAVE`
		- [x] uint32_t CRC32 from `game.dat` (so we know if versions match)
		- [x] uint32_t length of the `save_[0,1,2].dat`
- [x] Improve the "Power on" experience of the hardware
	- [x] ROM _is_ valid,
		- [x] and SD _is not_ present, start game
		- [x] and SD _is_ present, hash is same, start game
		- [x] and SD _is_ present, hash is diff, show options
		- [x] and SD _is_ present, MEM3 is held, show options
	- [x] ROM _is not_ valid,
		- [x] and SD _is not_ present, engine panic with message about no rom
		- [x] and SD _is_ present, _do not_ show options and just copy
	- [x] Desktop build should also ENGINE_PANIC if ROM Magic is bad
- [ ] Entity "Action" animation continues playing during dialog but only sometimes
- [ ] Entities go to space when the duration of a walk path is less than the milliseconds per frame of the current fps
- [x] Hamster has a bug report. The save icon's background dialog tileset is missing.
- [x] Use entity property `is_debug` (true) to make certain entities "Debug mode only"
	- [x] Set the "Warp Fish" `is_debug` true
	- [x] Set the Exa `entity_type` property `is_debug` true by default
	- [x] Add kaitai `render_flags` type to entity instance direction help show what's up
	- [x] Make encoder set the `0b0100000` renderFlags so those entities can be filtered out at runtime
	- [x] In engine, implement runtime "show debug entities" mode
		- [x] Add `is_debug` for `0b0100000` bit on renderFlags
		- [x] Pick a key combination to toggle this mode
			- [x] Pressing the key combination reloads the current map and disables the filter
		- [x] Filter the entities by the `0b0100000` renderFlags, while tracking the original + filtered entityId
			- [x] Make an array that maps `mapLocalEntityId` to `filteredMapLocalEntityId`
			- [x] Change the getEntity* methods to use this
		- [x] Diligence:
			- [x] Review all usages of `MAX_ENTITIES_PER_MAP`
			- [x] Review all usages of `map.EntityCount()`
			- [x] Review all usages of `entities[`
			- [x] Review all usages of `entityRenderableData[` -> `getEntityRenderableDataByMapLocalId`
			- [x] Review all usages of `filteredMapLocalEntityIds`
			- [x] Review all usages of `mapLocalEntityIds`
			- [x] Review all usages of `playerEntityIndex`
			- [x] Review all usages of `cameraFollowEntityId`
			- [x] Make sure that entity hacking still doesn't jank the player
			- [x] Make sure that camera wiggle functions still work
			- [x] Test it on the hardware
- [x] Make a "Warp Zone" map that can take players to all of the debug maps
	- [x] Make the "Warp Fish" send the player the "Warp Zone"
	- [x] Add the "Warp Fish" fish to all the debug maps

## Encoder TODO:
- [x] Throw error when > 1 entities have `is_player`
- [ ] Build a test map with no entities and make sure it does not crash
- [x] Fix bug where empty string for script on map or entity does not encode as null_script
- [ ] Music/SFX encoding in the binary asset encoder

## Hardware TODO:

- [x] Get keyboard chip working and reliably updating button states
- [x] Get LED control chip working and update LED control functions
- [x] Update FrameBuffer.h to work with the new larger screen
- [x] Use SD card for testing game until ROM chip is functional
- [ ] Get ROM chip read/write working reliably
- [ ] Verify function of all desktop testing build features are working correctly on badge hardware
- [ ] Fix audio driver and initialize communication with audio chip

# MAJOR GAMEPLAY AND QUEST SPOILERS BELOW!

## Assets we need
- [ ] More villagers
	- [ ] One of the children's actions should be a sneeze
- [ ] The other mystical artifacts, which do _not_ pick the mage
- [x] Ring Zero, spinning
- [ ] Chicken
- [ ] Sparkles that could be overlayed on anything to draw attention
- [ ] Character Portraits for the Dialog system
	- [ ] Mouth open, closed
- [x] The Quest Board tiles
- [X] The 9-slice image for "Quest List" screen
- [X] The 9-slice image for dialog borders
- [ ] Tiles for the inside of village houses
- [ ] Set Dressing
	- [ ] Bed
	- [ ] Flower Pots
	- [ ] Windows
	- [ ] Kitchen table
	- [ ] Kitchen chairs at table
	- [ ] Pots
	- [ ] Interior Doors for all 4 walls
	- [ ] Fireplace
	- [ ] Shelves with things on them
	- [ ] Fruits on table
	- [ ] Fence Posts to paint, so we need 2 states
	- [ ] Dancy Flowers
	- [ ] A rake, for the lake
- [ ] A knob that has never turned, but must be turned to get the fountain to turn on again
- [ ] A well, for Timmy to get stuck in
- [ ] Tiles for village elder's basement/dungeon
- [X] Bender + shiny metal ass
